resources:
  - name: source
    type: git
    public: true
    icon: git
    source:
      uri: git@github.com:watchedsky-social/core.git
      private_key: ((core-deploy-key))
  - name: daily-trigger
    type: time
    public: true
    icon: timer-outline
    source:
      interval: 24h
  - name: oci-build-task-image
    type: registry-image
    public: true
    icon: docker
    source:
      repository: concourse/oci-build-task
  - name: destination
    type: registry-image
    public: true
    icon: docker
    source:
      repository: registry.lab.verysmart.house/watchedsky/core
      username: ((harbor-user))
      password: ((harbor-password))

jobs:
  - name: build
    public: true
    serial: true
    plan:
      - in_parallel:
          - get: source
            trigger: true
          - get: daily-trigger
            trigger: true
          - get: oci-build-task-image
            params:
              format: rootfs
      - in_parallel:
          - load_var: version
            file: source/.git/describe_ref
          - task: build-image
            image: oci-build-task-image
            privileged: true
            config:
              platform: linux
              inputs: [{ name: source }]
              outputs: [{ name: image }]
              caches: [{ path: cache }]
              params: { CONTEXT: source, BUILDKIT_SECRETTEXT_env: "WATCHEDSKY_DB_PASSWORD=((db-password))" }
              run: { path: build }
      - put: destination
        params:
          image: image/image.tar
          version: ((.:version))
          bump_aliases: true
